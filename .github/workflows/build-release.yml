name: Build and Release (ARM64 + Intel)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write
  actions: read

env:
  APP_NAME_CN: æ•°æ®åº“å·¥å…·
  APP_NAME_EN: mysql_tool
  PYTHON_VERSION: '3.11'

jobs:
  build-arm64:
    runs-on: macos-15
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-arm64-pyqt5-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller==6.11.0
          python -c "from PyQt5 import QtCore; print(f'PyQt5: {QtCore.PYQT_VERSION_STR}')"
          python -c "import mysql.connector; print(f'mysql-connector: {mysql.connector.__version__}')"

      - name: Inject configs
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          if [ -f "config/config.ini.template" ]; then
            cp config/config.ini.template config/config.ini
          fi
          sed -i '' "s/{{DB_HOST}}/${DB_HOST:-localhost}/g" config/config.ini
          sed -i '' "s/{{DB_PORT}}/${DB_PORT:-3306}/g" config/config.ini
          sed -i '' "s/{{DB_USER}}/${DB_USER:-root}/g" config/config.ini
          sed -i '' "s/{{DB_PASSWORD}}/${DB_PASSWORD:-}/g" config/config.ini
          sed -i '' "s/{{DB_NAME}}/${DB_NAME:-test}/g" config/config.ini

      - name: Build ARM64
        run: |
          sed -i '' "s/target_arch=None/target_arch='arm64'/" main.spec
          sed -i '' "s|entitlements_file=None|entitlements_file='entitlements.plist'|" main.spec
          
          pyinstaller --noconfirm main.spec
          file "dist/${{ env.APP_NAME_CN }}.app/Contents/MacOS/main"

      - name: Package ARM64 (DMG)
        id: package
        run: |
          cd dist
          
          brew install create-dmg
          
          DMG_NAME="${{ env.APP_NAME_EN }}_AppleSilicon.dmg"
          VOL_NAME="${{ env.APP_NAME_CN }} Apple Silicon"
          
          if create-dmg \
            --volname "$VOL_NAME" \
            --window-pos 200 120 \
            --window-size 800 500 \
            --icon-size 100 \
            --app-drop-link 550 200 \
            --hide-extension "${{ env.APP_NAME_CN }}.app" \
            --format UDZO \
            "$DMG_NAME" \
            "${{ env.APP_NAME_CN }}.app" 2>/dev/null; then
          
            echo "dmg_created=true" >> $GITHUB_ENV
            mv "$DMG_NAME" "../$DMG_NAME"
            cd ..
            FILE_SIZE=$(du -h "$DMG_NAME" | cut -f1)
            echo "arm64_size=$FILE_SIZE" >> $GITHUB_ENV
            echo "asset_path=$DMG_NAME" >> $GITHUB_OUTPUT
            echo "asset_name=$DMG_NAME" >> $GITHUB_OUTPUT
          
          else
            echo "dmg_created=false" >> $GITHUB_ENV
            ZIP_NAME="${{ env.APP_NAME_EN }}_AppleSilicon.zip"
            ditto -c -k --keepParent "${{ env.APP_NAME_CN }}.app" "../$ZIP_NAME"
            cd ..
            FILE_SIZE=$(du -h "$ZIP_NAME" | cut -f1)
            echo "arm64_size=$FILE_SIZE" >> $GITHUB_ENV
            echo "asset_path=$ZIP_NAME" >> $GITHUB_OUTPUT
            echo "asset_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ${{ env.APP_NAME_CN }} ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ### æ„å»ºçŠ¶æ€
            - âœ… Apple Silicon (ARM64): å·²å®Œæˆ (${{ env.arm64_size }})
            - â³ Intel (x86_64): ç­‰å¾…æœ¬åœ°æ„å»º...
            
            ### ä¾èµ–ç‰ˆæœ¬
            - PyQt5: 5.15.11
            - mysql-connector-python: 9.5.0
            - Jinja2: 3.1.6
            
            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ **DMG** æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€ DMGï¼Œå°† App æ‹–åˆ° **åº”ç”¨ç¨‹åº** æ–‡ä»¶å¤¹
            3. é¦–æ¬¡è¿è¡Œæç¤ºå®‰å…¨éªŒè¯ï¼Œåœ¨è®¾ç½®"éšç§ä¸å®‰å…¨è¡Œ"ä¸­ä»è¦æ‰“å¼€
            
            ### ä¸‹è½½
            **Apple Silicon (M1/M2/M3/M4)**: ä¸‹è½½ `${{ env.APP_NAME_EN }}_AppleSilicon.${{ env.dmg_created == 'true' && 'dmg' || 'zip' }}`
            
            **Intel Mac**: â³ è¯·ç­‰å¾… Intel ç‰ˆæœ¬ä¸Šä¼ ...
          draft: true
          prerelease: false
          files: |
            ${{ steps.package.outputs.asset_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print local build instructions
        run: |
          echo "::notice title=æœ¬åœ°æ„å»º::è¿è¡Œ: make build-intel æˆ– ./build-intel-local.sh ${{ steps.get_version.outputs.version }}"