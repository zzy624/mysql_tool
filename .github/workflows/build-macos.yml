name: Build macOS App (Multi-Arch)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如: 1.0.0)'
        required: true
        default: '1.0.0'

env:
  APP_NAME: 数据库调试工具
  PYTHON_VERSION: '3.11'

jobs:
  # Intel 版本（使用 macos-15-large）
  build-intel:
    runs-on: macos-15-large  #
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (Intel)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: x64  # 明确指定 x64

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-intel-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pyqt6 pyqt6-tools
          pip install mysql-connector-python
          
          # 验证架构
          python -c "import mysql.connector; print('MySQL Connector OK')"
          file $(python -c "import mysql.connector; print(mysql.connector.__file__)")

      - name: Inject configs
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          # 替换配置文件中的占位符
          sed -i '' "s/{{DB_HOST}}/$DB_HOST/g" config/config.ini
          sed -i '' "s/{{DB_PORT}}/$DB_PORT/g" config/config.ini
          sed -i '' "s/{{DB_USER}}/$DB_USER/g" config/config.ini
          sed -i '' "s/{{DB_PASSWORD}}/$DB_PASSWORD/g" config/config.ini
          sed -i '' "s/{{DB_NAME}}/$DB_NAME/g" config/config.ini

      - name: Build Intel version
        run: |
          # 修改 spec 文件为 x86_64
          sed -i '' "s/target_arch=None/target_arch='x86_64'/" main.spec
          sed -i '' "s|entitlements_file=None|entitlements_file='entitlements.plist'|" main.spec
          
          pyinstaller --noconfirm main.spec
          
          # 验证架构
          echo "=== 验证 Intel 架构 ==="
          file "dist/${{ env.APP_NAME }}.app/Contents/MacOS/main"
          lipo -archs "dist/${{ env.APP_NAME }}.app/Contents/MacOS/main" || echo "单架构文件"

      - name: Package Intel
        run: |
          cd dist
          # 重命名以区分架构
          mv "${{ env.APP_NAME }}.app" "${{ env.APP_NAME }}_Intel.app"
          ditto -c -k --keepParent "${{ env.APP_NAME }}_Intel.app" "../${{ env.APP_NAME }}_Intel.zip"

      - name: Upload Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-intel
          path: ${{ env.APP_NAME }}_Intel.zip

  # Apple Silicon 版本（使用 macos-15）
  build-arm64:
    runs-on: macos-15  # ✅ 修复：使用最新 ARM64 runner
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (ARM64)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: arm64

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-arm64-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pyqt6 pyqt6-tools
          pip install mysql-connector-python

      - name: Inject configs
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          sed -i '' "s/{{DB_HOST}}/$DB_HOST/g" config/config.ini
          sed -i '' "s/{{DB_PORT}}/$DB_PORT/g" config/config.ini
          sed -i '' "s/{{DB_USER}}/$DB_USER/g" config/config.ini
          sed -i '' "s/{{DB_PASSWORD}}/$DB_PASSWORD/g" config/config.ini
          sed -i '' "s/{{DB_NAME}}/$DB_NAME/g" config/config.ini

      - name: Build ARM64 version
        run: |
          # 修改 spec 文件为 arm64
          sed -i '' "s/target_arch=None/target_arch='arm64'/" main.spec
          sed -i '' "s|entitlements_file=None|entitlements_file='entitlements.plist'|" main.spec
          
          pyinstaller --noconfirm main.spec
          
          # 验证架构
          echo "=== 验证 ARM64 架构 ==="
          file "dist/${{ env.APP_NAME }}.app/Contents/MacOS/main"
          lipo -archs "dist/${{ env.APP_NAME }}.app/Contents/MacOS/main" || echo "单架构文件"

      - name: Package ARM64
        run: |
          cd dist
          mv "${{ env.APP_NAME }}.app" "${{ env.APP_NAME }}_AppleSilicon.app"
          ditto -c -k --keepParent "${{ env.APP_NAME }}_AppleSilicon.app" "../${{ env.APP_NAME }}_AppleSilicon.zip"

      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-arm64
          path: ${{ env.APP_NAME }}_AppleSilicon.zip

  # 发布到 GitHub Releases
  release:
    needs: [build-intel, build-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: app-*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/app-intel/*.zip
            artifacts/app-arm64/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## 下载说明
            
            根据你的 Mac 芯片选择对应版本：
            
            - **Intel 芯片（旧款 Mac）**：下载 `数据库调试工具_Intel.zip`
            - **Apple Silicon（M1/M2/M3）**：下载 `数据库调试工具_AppleSilicon.zip`（性能更好）

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}